(function($){if(!Array.isArray){Array.isArray=function(arg){return Object.prototype.toString.call(arg)==="[object Array]"}}var option={id:0,url:"",position:"center center",offset:{x:0,y:0},interactive:false,mask:false,maskShape:"rect",maskSize:{w:200,h:200},scale:1,enabledMultiTouches:true};var id=1;function Scale(images){var self=this;function createScaleObj(options,bm){return $.extend({},options,{bm:bm})}function combineScaleObjectWidthOld(imageOptions,exitOptions,bm){var newScaleObj=null;if(exitOptions){var exitBmCopy=exitOptions.bm;delete exitBmCopy.image;bm=$.extend(true,{},exitBmCopy,bm);newScaleObj=createScaleObj(imageOptions,bm)}else{newScaleObj=createScaleObj(imageOptions,bm)}return newScaleObj}function generateOptions(options,exitOptions){var index=id++;var imageOptions=null;if(typeof options==="string"){imageOptions=$.extend({},option,{id:index},{url:options});if(exitOptions){delete exitOptions.url;imageOptions=extendExitOptions(imageOptions,exitOptions)}}else if(typeof options==="object"){imageOptions=$.extend(true,{},option,{id:index},options);if(exitOptions){imageOptions=extendExitOptions(exitOptions,imageOptions)}}if(imageOptions.mask){if(imageOptions.maskShape==="rect"){imageOptions.maskSize=options.maskSize||{w:200,h:200}}else if(imageOptions.maskShape==="circle"){imageOptions.maskSize=options.maskSize||{x:0,y:0,radius:100}}}else{if(exitOptions){exitOptions.bm.mask=null}delete imageOptions.maskSize;delete imageOptions.maskShape}return imageOptions}function extendExitOptions(exitOptions,imageOptions){var newOptions;var oldOptionsCopy=$.extend(true,{},exitOptions);if(imageOptions.url){delete oldOptionsCopy.url;delete oldOptionsCopy.id;delete oldOptionsCopy.bm}newOptions=$.extend(true,{},oldOptionsCopy,imageOptions);return newOptions}function addChild(options,position,exitOptions){var imageOptions=generateOptions(options,exitOptions);var images=self.images;position=position&&Number(position);if(position>=images.length){position=images.length}if(imageOptions){addImage(self,imageOptions,function(bm){var newScaleObj=combineScaleObjectWidthOld(imageOptions,exitOptions,bm);if(typeof position==="number"){self.images=images.slice(0,position).concat(newScaleObj).concat(images.slice(position))}else{self.images.push(newScaleObj)}draw(self,self.images);if(typeof imageOptions.interactive==="boolean"&&imageOptions.interactive){addEvents(self,newScaleObj.bm,newScaleObj)}})}}function replaceChild(options,position,exitOptions){var imageOptions=generateOptions(options,exitOptions);var images=self.images;position=position&&Number(position);if(position>=images.length){position=images.length}if(imageOptions){addImage(self,imageOptions,function(bm){var newScaleObj=combineScaleObjectWidthOld(imageOptions,exitOptions,bm);if(typeof position==="number"){self.images.splice(position,1,newScaleObj)}draw(self,self.images);if(typeof imageOptions.interactive==="boolean"&&imageOptions.interactive){addEvents(self,newScaleObj.bm,newScaleObj)}})}}function removeItemInArray(array,key,value){for(var i=0;i<array.length;i++){if(value==array[i][key]){if(array[i].bm){array[i].bm.removeAllEventListeners()}array=array.slice(0,i).concat(array.slice(i+1));i--}}return array}this.addChild=function(options){addChild(options)};this.addChildAt=function(options,index){addChild(options,index)};this.clear=function(){self.images.length=0;draw(self,self.images)};this.getAllImages=function(){return self.images.slice()};this.getOptions=function(id){var resultImage=[];var images=self.images;images.forEach(function(image,index){if(image.id==id){resultImage.push(image)}});return resultImage.length===1?resultImage[0]:resultImage};this.removeChild=function(id){var images=self.images.slice();images=removeItemInArray(images,"id",id);self.clear();self.images=images.slice();draw(self,self.images);return this};this.replace=function(id,img,keepProperties){var options=null;keepProperties=keepProperties||false;var images=self.images;for(var i=0;i<images.length;i++){if(images[i].id==id){if(keepProperties){options=images[i]}replaceChild(img,i,options)}}return this};this.setOption=function(id,options){var images=self.images.slice();var selectedId=id;images.forEach(function(image,i){if(image.id==selectedId){options=$.extend(true,{},options,{url:options.url||image.url});self.replace(selectedId,options,true)}});return this};this.toDataURL=function(mime,quality){var stage=self.stage;var canvas=stage.canvas;mime=mime||"image/png";quality=quality||.92;return canvas.toDataURL(mime,quality)};var $canvas=insertCanvas(self);this.stage=new createjs.Stage($canvas);this.container=new createjs.Container;this.container.width=this.stage.canvas.width;this.container.height=this.stage.canvas.height;this.stage.enableMouseOver(20);createjs.Touch.enable(this.stage);createjs.Ticker.addEventListener("tick",function(){self.stage.update()});this.images=[];if(images&&Array.isArray(images)&&images.length>=1){images.forEach(function(image){(function(img){addChild(img)})(image)})}return this}function zoom(x1,y1,image){if(image.scaledSize==undefined){image.scaledSize=image.image.width}var scaledSize=image.image.width*image.scaleX;var scaled=(scaledSize-image.scaledSize)/image.scaledSize;image.scaledSize=scaledSize;var x2=image.x;var y2=image.y;var hGap=x2-x1;var vGap=y2-y1;var xD=hGap>=0?1:-1;var yD=vGap>=0?1:-1;hGap=Math.abs(hGap);vGap=Math.abs(vGap);return{x:x2+xD*hGap*scaled,y:y2+yD*vGap*scaled}}function addImage($container,image,cb){var bm=null;if(typeof image==="string"){var imageElem=new Image;imageElem.onload=function(){bm=createBitMap($container,imageElem,image);cb(bm)};imageElem.src=image}else if(typeof image==="object"){if(image.nodeType===1){bm=createBitMap($container,image);cb(bm)}else if(image.url){var imageElem2=new Image;imageElem2.onload=function(){bm=createBitMap($container,imageElem2,image);cb(bm)};imageElem2.src=image.url}}function createBitMap($container,image,options){var bm=new createjs.Bitmap(image);var position=options.position;var offset=options.offset;var positions=getPositions($container,position);var imageOffset=getDefaultOffsets(bm.image,position);var scale=getScale($container,bm.image,options.scale);var x=$container.width()/2;var y=$container.height()/2;var regX=imageOffset.x;var regY=imageOffset.y;if(positions){x=positions.x;y=positions.y}else if($container.image!=null){x=$container.image.x;y=$container.image.y}bm.regX=offset?offset.x+regX:regX;bm.regY=offset?offset.y+regY:regY;bm.x=x;bm.y=y;bm.scaleX=scale.scaleX;bm.scaleY=scale.scaleY;if(options.mask){bm.mask=createMask(options.maskShape,options.maskSize,bm,scale,options)}return bm}}function insertCanvas($container){var canvas=$('<canvas id="canvas" width="'+$container.width()*2+'" height="'+$container.height()*2+'">').get(0);var ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=false;canvas.style.width=$container.width()+"px";canvas.style.height=$container.height()+"px";$container.empty().append(canvas);return canvas}function addEvents($container,image,options){var stage=$container.stage;var touchpoints;var newTouchpoints;var touchResult;var initDis;var initrotation;var isMultiTouch=false;var now=(new Date).getTime();image.on("mousedown",function(e){if(e.primary&&image){image.offset={x:image.x-e.stageX,y:image.y-e.stageY}}if(options.enabledMultiTouches){var ne=e.nativeEvent;var targetTouches=ne.targetTouches;if(targetTouches){var touchnum=targetTouches.length;switch(touchnum){case 1:touchpoints=[{x:targetTouches[0].pageX,y:targetTouches[0].pageY}];break;case 2:touchpoints=[{x:targetTouches[0].pageX,y:targetTouches[0].pageY},{x:targetTouches[1].pageX,y:targetTouches[1].pageY}];initDis=caculatepointsDistance(touchpoints[0],touchpoints[1]).offsetdistance;initrotation=caculatepointsDistance(touchpoints[0],touchpoints[1]).angle/Math.PI*180;isMultiTouch=true}}else{touchpoints=[{x:ne.pageX,y:ne.pageY}]}}});image.on("pressmove",function(e){if(!isMultiTouch){if(e.primary&&image&&image.offset){image.x=e.stageX+image.offset.x;image.y=e.stageY+image.offset.y}}else{if(options&&options.enabledMultiTouches){var ne=e.nativeEvent;var targetTouches=ne.targetTouches;if(targetTouches){var touchnum=targetTouches.length;switch(touchnum){case 1:newTouchpoints=[{x:targetTouches[0].pageX,y:targetTouches[0].pageY}];break;case 2:newTouchpoints=[{x:targetTouches[0].pageX,y:targetTouches[0].pageY},{x:targetTouches[1].pageX,y:targetTouches[1].pageY}];touchResult=handleTouchsByMultiPoints(newTouchpoints,touchpoints,initDis);break}}touchpoints=newTouchpoints;if(newTouchpoints&&newTouchpoints.length>1){var centerPoint={x:(newTouchpoints[0].x+newTouchpoints[1].x)/2*2,y:(newTouchpoints[0].y+newTouchpoints[1].y)/2*2};var sc=0;if(image.scaleX<0){sc=image.scaleX*-1+touchResult.scale;sc=Math.max(sc,.1);sc*=-1}else{sc=image.scaleX+touchResult.scale;sc=Math.max(sc,.1)}var newPos=zoom(centerPoint.x,centerPoint.y,image);image.x=newPos.x;image.y=newPos.y;image.scaleX=sc;image.scaleY=Math.abs(sc);image.rotation+=touchResult.angle}}}draw($container,$container.images)});image.on("pressup",function(e){if(e.primary&&image){image.offset=null}var targetTouches=e.nativeEvent.targetTouches;isMultiTouch=targetTouches&&targetTouches.length===1;draw($container,$container.images)});return{stage:stage}}function getPositions($container,position){var stageWidth=$container.width()*2;var stageHeight=$container.height()*2;var container={width:stageWidth,height:stageHeight};position=position.toLowerCase();return matchPosition(container,position)}function getDefaultOffsets(image,position){var container={width:image.width,height:image.height};position=position.toLowerCase();return matchPosition(container,position)}function matchPosition(container,position){var px=0,py=0,width=container.width,height=container.height;switch(position){case"top left":case"left top":px=0;py=0;break;case"top center":case"center top":px=width/2;py=0;break;case"top right":case"right top":px=width;py=0;break;case"center left":case"left center":px=0;py=height/2;break;case"center center":case"center":px=width/2;py=height/2;break;case"center right":case"right center":px=width;py=height/2;break;case"bottom left":case"left bottom":px=0;py=height;break;case"bottom center":case"center bottom":px=width/2;py=height;break;case"bottom right":case"right bottom":px=width;py=height;break;default:px=0;py=0}return{x:px,y:py}}function getScale($container,image,scale){var scaleX=1;var scaleY=1;var containerWidth=$container.stage.canvas.width;var containerHeight=$container.stage.canvas.height;if(scale&&typeof scale==="number"){scaleX=scale;scaleY=scale}else if(scale&&typeof scale==="string"){if(scale==="contain"){if(image.width>=image.height){scaleX=containerWidth/image.width;scaleY=containerWidth/image.width}else{scaleX=containerHeight/image.height;scaleY=containerHeight/image.height}}else if(scale==="cover"){if(image.width>=image.height){scaleX=containerHeight/image.height;scaleY=containerHeight/image.height}else{scaleX=containerWidth/image.width;scaleY=containerWidth/image.width}}}return{scaleX:scaleX,scaleY:scaleY}}function createMask(shape,size,bm,scale){var containerMask=new createjs.Shape;containerMask.width=bm.image.width*scale.scaleX;containerMask.height=bm.image.height*scale.scaleY;if(shape==="rect"){containerMask.graphics.beginFill("#ffffff").drawRect(bm.x-size.w/2,bm.y-size.h/2,size.w,size.h)}else if(shape==="circle"){size={x:bm.x+size.x,y:bm.y+size.y,radius:size.radius};containerMask.graphics.beginFill("#ffffff").drawCircle(size.x,size.y,size.radius)}return containerMask}function draw($container,images){var stage=$container.stage;var container=$container.container;stage.removeAllChildren();container.removeAllChildren();images.forEach(function(img,i){container.addChild(img.bm)});stage.addChild(container);stage.update()}function drawForegroundImages($container,images){var stage=$container.stage;images.forEach(function(img,i){stage.addChild(img.bm)});stage.update()}function caculatepointsDistance(point1,point2){var result={};var movex=point2.x-point1.x;var movey=point2.y-point1.y;var distance=Math.sqrt(movex*movex+movey*movey);var angle1,angle2,anglebe;angle1=Math.atan2(movey,movex);result.offsetx=movex;result.offsety=movey;result.offsetdistance=distance;result.angle=angle1;return result}function handleTouchsByMultiPoints(points1,points2,initDis){var result1=caculatepointsDistance(points1[0],points1[1]);var result2=caculatepointsDistance(points2[0],points2[1]);var dis=result2.offsetdistance-result1.offsetdistance;var ang=result2.angle-result1.angle;var sc=-dis/initDis/2;var mainresult={};mainresult.angle=-ang/Math.PI*180;mainresult.scale=sc;mainresult.points=points1;return mainresult}$.fn.extend({Scale:Scale})})(jQuery);